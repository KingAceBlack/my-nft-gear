<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mint Gear NFT</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: #1a1a2e;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding: 20px;
        }

        .container {
            background: #16213e;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 10px 50px rgba(0,0,0,0.5);
            max-width: 900px;
            width: 100%;
            text-align: center;
        }

        h1 {
            color: #64b5f6;
            margin-bottom: 10px;
            font-size: 2.5em;
        }

        .subtitle {
            color: #e0e0e0;
            margin-bottom: 30px;
            font-size: 1.1em;
        }

        .wallet-status {
            background: #0f3460;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            color: #e0e0e0;
        }

        .wallet-address {
            color: #64b5f6;
            font-family: monospace;
            font-size: 0.9em;
            word-break: break-all;
        }

        .mint-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 18px 50px;
            font-size: 1.2em;
            font-weight: bold;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
            width: 100%;
            margin-bottom: 15px;
        }

        .mint-button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }

        .mint-button:disabled {
            background: #444;
            cursor: not-allowed;
            box-shadow: none;
        }

        .connect-button {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            border: none;
            padding: 18px 50px;
            font-size: 1.2em;
            font-weight: bold;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(245, 87, 108, 0.4);
            width: 100%;
        }

        .connect-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(245, 87, 108, 0.6);
        }

        .status-message {
            background: #0f3460;
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
            color: #e0e0e0;
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .success {
            color: #4caf50;
        }

        .error {
            color: #ff6b6b;
        }

        .loading {
            color: #64b5f6;
        }

        .spinner {
            border: 3px solid rgba(255,255,255,0.1);
            border-top: 3px solid #64b5f6;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .nft-display {
            margin-top: 30px;
            display: none;
        }

        .nft-display.show {
            display: block;
        }

        .nft-frame {
            background: #0f3460;
            border-radius: 15px;
            padding: 20px;
        }

        canvas {
            width: 100%;
            max-width: 500px;
            height: auto;
            border-radius: 10px;
            margin-bottom: 15px;
            background: #000000;
            image-rendering: -webkit-optimize-contrast;
            image-rendering: crisp-edges;
        }

        .nft-info {
            background: #16213e;
            border-radius: 10px;
            padding: 15px;
            margin-top: 10px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .trait {
            display: flex;
            justify-content: space-between;
            padding: 8px;
            background: #0f3460;
            border-radius: 5px;
        }

        .trait-label {
            color: #64b5f6;
            font-weight: 600;
            font-size: 0.9em;
        }

        .trait-value {
            color: #e0e0e0;
            font-size: 0.9em;
        }

        .view-on-opensea {
            background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
            color: #1a1a2e;
            border: none;
            padding: 12px 30px;
            font-size: 1em;
            font-weight: bold;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            margin-top: 15px;
        }

        .view-on-opensea:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(67, 233, 123, 0.4);
        }

        @media (max-width: 768px) {
            .nft-info {
                grid-template-columns: 1fr;
            }
        }
    </style>
    <!-- Include ethers.js FIRST -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
</head>
<body>
    <div class="container">
        <h1>⚔️ Gear NFT</h1>
        <p class="subtitle">Mint Your Legendary Equipment</p>

        <div id="walletSection">
            <button class="connect-button" id="connectBtn" onclick="connectWallet()">
                Connect Wallet
            </button>
        </div>

        <div id="mintSection" style="display: none;">
            <div class="wallet-status">
                <div>Connected: <span class="wallet-address" id="walletAddress"></span></div>
            </div>

            <button class="mint-button" id="mintBtn" onclick="mintNFT()">
                Mint NFT
            </button>

            <div class="status-message" id="statusMessage">
                Ready to mint your Gear NFT
            </div>
        </div>

        <div class="nft-display" id="nftDisplay">
            <div class="nft-frame">
                <h2 style="color: #64b5f6; margin-bottom: 15px;" id="nftName">Gear #0</h2>
                <canvas id="nftCanvas" width="2160" height="2160"></canvas>
                <div class="nft-info" id="nftInfo"></div>
                <a id="openseaLink" class="view-on-opensea" href="#" target="_blank">
                    View on OpenSea
                </a>
            </div>
        </div>
    </div>

    <script>
        const CONTRACT_ADDRESS = "0x08AfB85e85cde4057ac548E4F3A975DA39D48391";
        const CONTRACT_ABI = [
            "function mint() external returns (uint256)",
            "function tokenURI(uint256 tokenId) external view returns (string memory)",
            "event Minted(uint256 indexed id)"
        ];

        let provider;
        let signer;
        let contract;
        let userAddress;

        // Image URLs for all gear
        const HEADGEAR_IMAGES = [
            "https://raw.githubusercontent.com/KingAceBlack/my-nft-gear/main/head-gear/AncientHelm_Simple.png",
            "https://raw.githubusercontent.com/KingAceBlack/my-nft-gear/main/head-gear/OrnateHelm_Simple.png",
            "https://raw.githubusercontent.com/KingAceBlack/my-nft-gear/main/head-gear/GreatHelm_Simple.png",
            "https://raw.githubusercontent.com/KingAceBlack/my-nft-gear/main/head-gear/FullHelm_Simple.png",
            "https://raw.githubusercontent.com/KingAceBlack/my-nft-gear/main/head-gear/Helm_Simple.png",
            "https://raw.githubusercontent.com/KingAceBlack/my-nft-gear/main/head-gear/DemonCrown_Simple.png",
            "https://raw.githubusercontent.com/KingAceBlack/my-nft-gear/main/head-gear/DragonCrown_Simple.png",
            "https://raw.githubusercontent.com/KingAceBlack/my-nft-gear/main/head-gear/WarCap_Simple.png",
            "https://raw.githubusercontent.com/KingAceBlack/my-nft-gear/main/head-gear/LeatherCap_Simple.png",
            "https://raw.githubusercontent.com/KingAceBlack/my-nft-gear/main/head-gear/Cap_Simple.png",
            "https://raw.githubusercontent.com/KingAceBlack/my-nft-gear/main/head-gear/Crown_Simple.png",
            "https://raw.githubusercontent.com/KingAceBlack/my-nft-gear/main/head-gear/DivineHood_Simple.png",
            "https://raw.githubusercontent.com/KingAceBlack/my-nft-gear/main/head-gear/SilkHood_Simple.png",
            "https://raw.githubusercontent.com/KingAceBlack/my-nft-gear/main/head-gear/LinenHood_Simple.png",
            "https://raw.githubusercontent.com/KingAceBlack/my-nft-gear/main/head-gear/Hood_Simple.png"
        ];

        const CHESTGEAR_IMAGES = [
            "https://raw.githubusercontent.com/KingAceBlack/my-nft-gear/main/chest-gear/DivineRobe_Simple.png",
            "https://raw.githubusercontent.com/KingAceBlack/my-nft-gear/main/chest-gear/SilkRobe_Simple.png",
            "https://raw.githubusercontent.com/KingAceBlack/my-nft-gear/main/chest-gear/LinenRobe_Simple.png",
            "https://raw.githubusercontent.com/KingAceBlack/my-nft-gear/main/chest-gear/Robe_Simple.png",
            "https://raw.githubusercontent.com/KingAceBlack/my-nft-gear/main/chest-gear/Shirt_Simple.png",
            "https://raw.githubusercontent.com/KingAceBlack/my-nft-gear/main/chest-gear/DemonHusk_Simple.png",
            "https://raw.githubusercontent.com/KingAceBlack/my-nft-gear/main/chest-gear/DragonskinArmor_Simple.png",
            "https://raw.githubusercontent.com/KingAceBlack/my-nft-gear/main/chest-gear/StuddedLeatherArmor_Simple.png",
            "https://raw.githubusercontent.com/KingAceBlack/my-nft-gear/main/chest-gear/HardLeatherArmor_Simple.png",
            "https://raw.githubusercontent.com/KingAceBlack/my-nft-gear/main/chest-gear/LeatherArmor_Simple.png",
            "https://raw.githubusercontent.com/KingAceBlack/my-nft-gear/main/chest-gear/HolyChestplate_Simple.png",
            "https://raw.githubusercontent.com/KingAceBlack/my-nft-gear/main/chest-gear/OrnateChestplate_Simple.png",
            "https://raw.githubusercontent.com/KingAceBlack/my-nft-gear/main/chest-gear/PlateMail_Simple.png",
            "https://raw.githubusercontent.com/KingAceBlack/my-nft-gear/main/chest-gear/ChainMail_Simple.png",
            "https://raw.githubusercontent.com/KingAceBlack/my-nft-gear/main/chest-gear/RingMail_Simple.png"
        ];

        const HANDGEAR_IMAGES = [
            "https://raw.githubusercontent.com/KingAceBlack/my-nft-gear/main/hand-gear/HolyGauntlets_Simple.png",
            "https://raw.githubusercontent.com/KingAceBlack/my-nft-gear/main/hand-gear/OrnateGauntlets_Simple.png",
            "https://raw.githubusercontent.com/KingAceBlack/my-nft-gear/main/hand-gear/Gauntlets_Simple.png",
            "https://raw.githubusercontent.com/KingAceBlack/my-nft-gear/main/hand-gear/ChainGloves_Simple.png",
            "https://raw.githubusercontent.com/KingAceBlack/my-nft-gear/main/hand-gear/HeavyGloves_Simple.png",
            "https://raw.githubusercontent.com/KingAceBlack/my-nft-gear/main/hand-gear/DemonsHands_Simple.png",
            "https://raw.githubusercontent.com/KingAceBlack/my-nft-gear/main/hand-gear/DragonskinGloves_Simple.png",
            "https://raw.githubusercontent.com/KingAceBlack/my-nft-gear/main/hand-gear/StuddedLeatherGloves_Simple.png",
            "https://raw.githubusercontent.com/KingAceBlack/my-nft-gear/main/hand-gear/HardLeatherGloves_Simple.png",
            "https://raw.githubusercontent.com/KingAceBlack/my-nft-gear/main/hand-gear/LeatherGloves_Simple.png",
            "https://raw.githubusercontent.com/KingAceBlack/my-nft-gear/main/hand-gear/DivineGloves_Simple.png",
            "https://raw.githubusercontent.com/KingAceBlack/my-nft-gear/main/hand-gear/SilkGloves_Simple.png",
            "https://raw.githubusercontent.com/KingAceBlack/my-nft-gear/main/hand-gear/WoolGloves_Simple.png",
            "https://raw.githubusercontent.com/KingAceBlack/my-nft-gear/main/hand-gear/LinenGloves_Simple.png",
            "https://raw.githubusercontent.com/KingAceBlack/my-nft-gear/main/hand-gear/Gloves_Simple.png"
        ];

        const WAISTGEAR_IMAGES = [
            "https://raw.githubusercontent.com/KingAceBlack/my-nft-gear/main/waist-gear/OrnateBelt_Simple.png",
            "https://raw.githubusercontent.com/KingAceBlack/my-nft-gear/main/waist-gear/WarBelt_Simple.png",
            "https://raw.githubusercontent.com/KingAceBlack/my-nft-gear/main/waist-gear/PlatedBelt_Simple.png",
            "https://raw.githubusercontent.com/KingAceBlack/my-nft-gear/main/waist-gear/MeshBelt_Simple.png",
            "https://raw.githubusercontent.com/KingAceBlack/my-nft-gear/main/waist-gear/HeavyBelt_Simple.png",
            "https://raw.githubusercontent.com/KingAceBlack/my-nft-gear/main/waist-gear/DemonhideBelt_Simple.png",
            "https://raw.githubusercontent.com/KingAceBlack/my-nft-gear/main/waist-gear/DragonskinBelt_Simple.png",
            "https://raw.githubusercontent.com/KingAceBlack/my-nft-gear/main/waist-gear/StuddedLeatherBelt_Simple.png",
            "https://raw.githubusercontent.com/KingAceBlack/my-nft-gear/main/waist-gear/HardLeatherBelt_Simple.png",
            "https://raw.githubusercontent.com/KingAceBlack/my-nft-gear/main/waist-gear/LeatherBelt_Simple.png",
            "https://raw.githubusercontent.com/KingAceBlack/my-nft-gear/main/waist-gear/BrightsilkSash_Simple.png",
            "https://raw.githubusercontent.com/KingAceBlack/my-nft-gear/main/waist-gear/SilkSash_Simple.png",
            "https://raw.githubusercontent.com/KingAceBlack/my-nft-gear/main/waist-gear/WoolSash_Simple.png",
            "https://raw.githubusercontent.com/KingAceBlack/my-nft-gear/main/waist-gear/LinenSash_Simple.png",
            "https://raw.githubusercontent.com/KingAceBlack/my-nft-gear/main/waist-gear/Sash_Simple.png"
        ];

        const FOOTGEAR_IMAGES = [
            "https://raw.githubusercontent.com/KingAceBlack/my-nft-gear/main/foot-gear/HolyGreaves_Simple.png",
            "https://raw.githubusercontent.com/KingAceBlack/my-nft-gear/main/foot-gear/OrnateGreaves_Simple.png",
            "https://raw.githubusercontent.com/KingAceBlack/my-nft-gear/main/foot-gear/Greaves_Simple.png",
            "https://raw.githubusercontent.com/KingAceBlack/my-nft-gear/main/foot-gear/ChainBoots_Simple.png",
            "https://raw.githubusercontent.com/KingAceBlack/my-nft-gear/main/foot-gear/HeavyBoots_Simple.png",
            "https://raw.githubusercontent.com/KingAceBlack/my-nft-gear/main/foot-gear/DemonhideBoots_Simple.png",
            "https://raw.githubusercontent.com/KingAceBlack/my-nft-gear/main/foot-gear/DragonskinBoots_Simple.png",
            "https://raw.githubusercontent.com/KingAceBlack/my-nft-gear/main/foot-gear/StuddedLeatherBoots_Simple.png",
            "https://raw.githubusercontent.com/KingAceBlack/my-nft-gear/main/foot-gear/HardLeatherBoots_Simple.png",
            "https://raw.githubusercontent.com/KingAceBlack/my-nft-gear/main/foot-gear/LeatherBoots_Simple.png",
            "https://raw.githubusercontent.com/KingAceBlack/my-nft-gear/main/foot-gear/DivineSlippers_Simple.png",
            "https://raw.githubusercontent.com/KingAceBlack/my-nft-gear/main/foot-gear/SilkSlippers_Simple.png",
            "https://raw.githubusercontent.com/KingAceBlack/my-nft-gear/main/foot-gear/WoolShoes_Simple.png",
            "https://raw.githubusercontent.com/KingAceBlack/my-nft-gear/main/foot-gear/LinenShoes_Simple.png",
            "https://raw.githubusercontent.com/KingAceBlack/my-nft-gear/main/foot-gear/Shoes_Simple.png"
        ];

        const RINGGEAR_IMAGES = [
            "https://raw.githubusercontent.com/KingAceBlack/my-nft-gear/main/ring-gear/GoldRing_Simple.png",
            "https://raw.githubusercontent.com/KingAceBlack/my-nft-gear/main/ring-gear/SilverRing_Simple.png",
            "https://raw.githubusercontent.com/KingAceBlack/my-nft-gear/main/ring-gear/BronzeRing_Simple.png",
            "https://raw.githubusercontent.com/KingAceBlack/my-nft-gear/main/ring-gear/PlatinumRing_Simple.png",
            "https://raw.githubusercontent.com/KingAceBlack/my-nft-gear/main/ring-gear/TitaniumRing_Simple.png"
        ];

        const NECKGEAR_IMAGES = [
            "https://raw.githubusercontent.com/KingAceBlack/my-nft-gear/main/neck-gear/Necklace_Simple.png",
            "https://raw.githubusercontent.com/KingAceBlack/my-nft-gear/main/neck-gear/Amulet_Simple.png",
            "https://raw.githubusercontent.com/KingAceBlack/my-nft-gear/main/neck-gear/Pendant_Simple.png"
        ];

        const ORDERGEAR_IMAGES = [
            "https://raw.githubusercontent.com/KingAceBlack/my-nft-gear/main/order-gear/Power.png",
            "https://raw.githubusercontent.com/KingAceBlack/my-nft-gear/main/order-gear/Giants.png",
            "https://raw.githubusercontent.com/KingAceBlack/my-nft-gear/main/order-gear/Titans.png",
            "https://raw.githubusercontent.com/KingAceBlack/my-nft-gear/main/order-gear/Skill.png",
            "https://raw.githubusercontent.com/KingAceBlack/my-nft-gear/main/order-gear/Perfection.png",
            "https://raw.githubusercontent.com/KingAceBlack/my-nft-gear/main/order-gear/Brilliance.png",
            "https://raw.githubusercontent.com/KingAceBlack/my-nft-gear/main/order-gear/Enlightenment.png",
            "https://raw.githubusercontent.com/KingAceBlack/my-nft-gear/main/order-gear/Protection.png",
            "https://raw.githubusercontent.com/KingAceBlack/my-nft-gear/main/order-gear/Anger.png",
            "https://raw.githubusercontent.com/KingAceBlack/my-nft-gear/main/order-gear/Rage.png",
            "https://raw.githubusercontent.com/KingAceBlack/my-nft-gear/main/order-gear/Fury.png",
            "https://raw.githubusercontent.com/KingAceBlack/my-nft-gear/main/order-gear/Vitriol.png",
            "https://raw.githubusercontent.com/KingAceBlack/my-nft-gear/main/order-gear/Fox.png",
            "https://raw.githubusercontent.com/KingAceBlack/my-nft-gear/main/order-gear/Detection.png",
            "https://raw.githubusercontent.com/KingAceBlack/my-nft-gear/main/order-gear/Reflection.png",
            "https://raw.githubusercontent.com/KingAceBlack/my-nft-gear/main/order-gear/Twins.png"
        ];

        const WEAPON_IMAGES = [
            "https://raw.githubusercontent.com/KingAceBlack/my-nft-gear/main/weapon/Warhammer_Simple.png",
            "https://raw.githubusercontent.com/KingAceBlack/my-nft-gear/main/weapon/Quarterstaff_Simple.png",
            "https://raw.githubusercontent.com/KingAceBlack/my-nft-gear/main/weapon/Maul_Simple.png",
            "https://raw.githubusercontent.com/KingAceBlack/my-nft-gear/main/weapon/Mace_Simple.png",
            "https://raw.githubusercontent.com/KingAceBlack/my-nft-gear/main/weapon/Club_Simple.png",
            "https://raw.githubusercontent.com/KingAceBlack/my-nft-gear/main/weapon/Katana_Simple.png",
            "https://raw.githubusercontent.com/KingAceBlack/my-nft-gear/main/weapon/Falchion_Simple.png",
            "https://raw.githubusercontent.com/KingAceBlack/my-nft-gear/main/weapon/Scimitar_Simple.png",
            "https://raw.githubusercontent.com/KingAceBlack/my-nft-gear/main/weapon/LongSword_Simple.png",
            "https://raw.githubusercontent.com/KingAceBlack/my-nft-gear/main/weapon/ShortSword_Simple.png",
            "https://raw.githubusercontent.com/KingAceBlack/my-nft-gear/main/weapon/GhostWand_Simple.png",
            "https://raw.githubusercontent.com/KingAceBlack/my-nft-gear/main/weapon/GraveWand_Simple.png",
            "https://raw.githubusercontent.com/KingAceBlack/my-nft-gear/main/weapon/BoneWand_Simple.png",
            "https://raw.githubusercontent.com/KingAceBlack/my-nft-gear/main/weapon/Wand_Simple.png",
            "https://raw.githubusercontent.com/KingAceBlack/my-nft-gear/main/weapon/Grimoire_Simple.png",
            "https://raw.githubusercontent.com/KingAceBlack/my-nft-gear/main/weapon/Chronicle_Simple.png",
            "https://raw.githubusercontent.com/KingAceBlack/my-nft-gear/main/weapon/Tome_Simple.png",
            "https://raw.githubusercontent.com/KingAceBlack/my-nft-gear/main/weapon/Book_Simple.png"
        ];

        function loadImage(url) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.crossOrigin = "anonymous";
                img.onload = () => resolve(img);
                img.onerror = () => reject(new Error(`Failed to load: ${url}`));
                img.src = url;
            });
        }

        async function connectWallet() {
            try {
                if (typeof window.ethereum === 'undefined') {
                    alert('Please install MetaMask to use this dApp!');
                    return;
                }

                const accounts = await window.ethereum.request({ 
                    method: 'eth_requestAccounts' 
                });

                userAddress = accounts[0];
                provider = new ethers.providers.Web3Provider(window.ethereum);
                signer = provider.getSigner();
                contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);

                document.getElementById('walletSection').style.display = 'none';
                document.getElementById('mintSection').style.display = 'block';
                document.getElementById('walletAddress').textContent = 
                    userAddress.slice(0, 6) + '...' + userAddress.slice(-4);

                window.ethereum.on('accountsChanged', (accounts) => {
                    if (accounts.length === 0) {
                        location.reload();
                    } else {
                        userAddress = accounts[0];
                        document.getElementById('walletAddress').textContent = 
                            userAddress.slice(0, 6) + '...' + userAddress.slice(-4);
                    }
                });

            } catch (error) {
                console.error('Error connecting wallet:', error);
                showStatus('Failed to connect wallet: ' + error.message, 'error');
            }
        }

        async function mintNFT() {
            const mintBtn = document.getElementById('mintBtn');

            try {
                mintBtn.disabled = true;
                showStatus('<div class="spinner"></div> Preparing transaction...', 'loading');

                const tx = await contract.mint();
                showStatus('<div class="spinner"></div> Minting in progress... Waiting for confirmation', 'loading');

                const receipt = await tx.wait();
                const mintedEvent = receipt.events.find(e => e.event === 'Minted');
                const tokenId = mintedEvent.args.id.toString();

                showStatus('✅ Successfully minted Gear #' + tokenId + '!', 'success');
                await displayNFT(tokenId);

            } catch (error) {
                console.error('Minting error:', error);
                let errorMsg = 'Minting failed';
                
                if (error.code === 4001) {
                    errorMsg = 'Transaction rejected by user';
                } else if (error.message) {
                    errorMsg = error.message;
                }
                
                showStatus('❌ ' + errorMsg, 'error');
                mintBtn.disabled = false;
            }
        }

        async function displayNFT(tokenId) {
            try {
                const tokenURI = await contract.tokenURI(tokenId);
                const base64Data = tokenURI.replace('data:application/json;base64,', '');
                const jsonString = atob(base64Data);
                const metadata = JSON.parse(jsonString);

                document.getElementById('nftName').textContent = metadata.name;

                // Extract gear indices from image URL
                const imageUrl = metadata.image;
                const queryString = imageUrl.split('?')[1];
                const params = new URLSearchParams(queryString);
                
                const head = parseInt(params.get('head'));
                const chest = parseInt(params.get('chest'));
                const hand = parseInt(params.get('hand'));
                const waist = parseInt(params.get('waist'));
                const foot = parseInt(params.get('foot'));
                const ring = parseInt(params.get('ring'));
                const neck = parseInt(params.get('neck'));
                const order = parseInt(params.get('order'));
                const weapon = parseInt(params.get('weapon'));

                // Render NFT on canvas
                await renderNFT(head, chest, hand, waist, foot, ring, neck, order, weapon);

                // Display attributes
                let attributesHTML = '';
                metadata.attributes.forEach(attr => {
                    attributesHTML += `
                        <div class="trait">
                            <span class="trait-label">${attr.trait_type}:</span>
                            <span class="trait-value">${attr.value}</span>
                        </div>
                    `;
                });
                document.getElementById('nftInfo').innerHTML = attributesHTML;

                // Set OpenSea link
                const network = await provider.getNetwork();
                let openseaUrl;
                if (network.chainId === 1) {
                    openseaUrl = `https://opensea.io/assets/ethereum/${CONTRACT_ADDRESS}/${tokenId}`;
                } else if (network.chainId === 11155111) {
                    openseaUrl = `https://testnets.opensea.io/assets/sepolia/${CONTRACT_ADDRESS}/${tokenId}`;
                } else {
                    openseaUrl = `https://testnets.opensea.io/assets/${CONTRACT_ADDRESS}/${tokenId}`;
                }
                document.getElementById('openseaLink').href = openseaUrl;

                document.getElementById('nftDisplay').classList.add('show');

            } catch (error) {
                console.error('Error displaying NFT:', error);
                showStatus('NFT minted but failed to load display', 'error');
            }
        }

        async function renderNFT(head, chest, hand, waist, foot, ring, neck, order, weapon) {
            const canvas = document.getElementById('nftCanvas');
            const ctx = canvas.getContext('2d');

            // Clear canvas with black background
            ctx.fillStyle = '#000000';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Show loading
            ctx.fillStyle = '#64b5f6';
            ctx.font = 'bold 48px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('Loading NFT...', canvas.width/2, canvas.height/2);

            try {
                // Load all images in the correct order
                const chestImg = await loadImage(CHESTGEAR_IMAGES[chest]);
                const waistImg = await loadImage(WAISTGEAR_IMAGES[waist]);
                const footImg = await loadImage(FOOTGEAR_IMAGES[foot]);
                const neckImg = await loadImage(NECKGEAR_IMAGES[neck]);
                const handImg = await loadImage(HANDGEAR_IMAGES[hand]);
                const ringImg = await loadImage(RINGGEAR_IMAGES[ring]);
                const orderImg = await loadImage(ORDERGEAR_IMAGES[order]);
                const headImg = await loadImage(HEADGEAR_IMAGES[head]);
                const weaponImg = await loadImage(WEAPON_IMAGES[weapon]);

                // Clear canvas again
                ctx.fillStyle = '#000000';
                ctx.fillRect(0, 0, canvas.width, canvas.height);

                // Draw layers from bottom to top
                ctx.drawImage(chestImg, 0, 0, canvas.width, canvas.height);
                ctx.drawImage(waistImg, 0, 0, canvas.width, canvas.height);
                ctx.drawImage(footImg, 0, 0, canvas.width, canvas.height);
                ctx.drawImage(neckImg, 0, 0, canvas.width, canvas.height);
                ctx.drawImage(handImg, 0, 0, canvas.width, canvas.height);
                ctx.drawImage(ringImg, 0, 0, canvas.width, canvas.height);
                ctx.drawImage(orderImg, 0, 0, canvas.width, canvas.height);
                ctx.drawImage(headImg, 0, 0, canvas.width, canvas.height);
                ctx.drawImage(weaponImg, 0, 0, canvas.width, canvas.height);

            } catch (error) {
                console.error('Error rendering NFT:', error);
                ctx.fillStyle = '#ff6b6b';
                ctx.font = 'bold 36px Arial';
                ctx.fillText('Error Loading Images', canvas.width/2, canvas.height/2);
                throw error;
            }
        }

        function showStatus(message, type) {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.innerHTML = message;
            statusDiv.className = 'status-message ' + type;
        }

        // Check if wallet is already connected on page load
        window.addEventListener('load', async () => {
            if (typeof window.ethereum !== 'undefined') {
                try {
                    const accounts = await window.ethereum.request({ 
                        method: 'eth_accounts' 
                    });
                    
                    if (accounts.length > 0) {
                        await connectWallet();
                    }
                } catch (error) {
                    console.error('Error checking wallet connection:', error);
                }
            }
        });
    </script>
</body>
</html> 
